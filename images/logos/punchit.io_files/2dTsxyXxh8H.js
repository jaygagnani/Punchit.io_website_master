/*!CK:645980415!*//*1441232585,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["ReBRM"]); }

__d('RTISubscriptionManager',['ChannelConstants','SystemEvents','invariant','setTimeoutAcrossTransitions','Arbiter','ErrorUtils','Run'],function a(b,c,d,e,f,g,h,i,j,k,l,m,n){if(c.__markCompiled)c.__markCompiled();'use strict';var o={SUBSCRIBE:'s',UNSUBSCRIBE:'u'},p=10000;function q(){this.$RTISubscriptionManager1={};this.$RTISubscriptionManager2=null;this.$RTISubscriptionManager3;this.$RTISubscriptionManager4=false;this.$RTISubscriptionManager5=false;this.$RTISubscriptionManager6=false;this.$RTISubscriptionManager7=false;this.$RTISubscriptionManager8=null;l.subscribe(h.ON_ENTER_STATE,(function(t,u){if(!this.$RTISubscriptionManager8)return;var v=/pull/.test(u.state);if(!this.$RTISubscriptionManager2&&v){this.$RTISubscriptionManager3=true;if(!this.$RTISubscriptionManager4){this.$RTISubscriptionManager4=true;k((function(){this.$RTISubscriptionManager2=this.$RTISubscriptionManager3;this.$RTISubscriptionManager4=false;if(this.$RTISubscriptionManager2)this.flush();}).bind(this),q.PULL_HINT_DELAY_MILLIS);}}else if(!v){this.$RTISubscriptionManager3=false;this.$RTISubscriptionManager2=false;}else if(v){this.$RTISubscriptionManager2=true;this.flush();}}).bind(this));i.subscribe(i.ONLINE,(function(t,u){if(!u){this.$RTISubscriptionManager2=false;this.$RTISubscriptionManager3=false;}}).bind(this));i.subscribe(i.USER,(function(t,u){this.$RTISubscriptionManager2=false;this.$RTISubscriptionManager3=false;this.$RTISubscriptionManager1={};}).bind(this));l.subscribe(h.RTI_SESSION,(function(t,u){if(!this.$RTISubscriptionManager8&&u)this.deleteSubscriptions(function(v){return v.getState()===o.UNSUBSCRIBE;});this.$RTISubscriptionManager8=u;if(this.$RTISubscriptionManager8){this.$RTISubscriptionManager2=true;this.flush();}}).bind(this));l.subscribe(h.ON_INVALID_HISTORY,(function(){this.$RTISubscriptionManager2=true;this.forEachSubscription(function(t,u){u.setDirty(true);});this.getCurrentSession();}).bind(this));this.getCurrentSession();l.subscribe(h.SKYWALKER,(function(t,u){var v=u.obj.topic,w={};if(u.obj.payloads===undefined){w.obj=[u.obj.payload];}else w.obj=u.obj.payloads;l.inform(h.getSkywalkerArbiterType(v),w);}).bind(this));}q.prototype.subscribe=function(t,u,v,w){!t?j(0):undefined;!u?j(0):undefined;if(Object.keys(this.$RTISubscriptionManager1).length<p){if(this.isSubscribed(t)){var x=this.$RTISubscriptionManager1[t];if(x&&x.getArbiterToken()){l.unsubscribe(x.getArbiterToken());x.setArbiterToken(null);}}var y=new s(t,u,v,w),z=new r(y);this.$RTISubscriptionManager1[t]=y;var aa=h.getSkywalkerArbiterType(t),ba=l.subscribe(aa,(function(ca,event){var da=event.obj.length;for(var ea=0;ea<da;ea++){var fa={topic:t,payload:event.obj[ea]};m.applyWithGuard(u,this,[fa]);}}).bind(this));y.setArbiterToken(ba);this.flush();return z;}return null;};q.prototype.unsubscribe=function(t){!t?j(0):undefined;if(t in this.$RTISubscriptionManager1){var u=this.$RTISubscriptionManager1[t];u.prepareUnsubscribe();if(u.getArbiterToken()){l.unsubscribe(u.getArbiterToken());u.setArbiterToken(null);}this.flush();}};q.prototype.unsubscribeAll=function(){this.forEachSubscription(function(t,u){u.prepareUnsubscribe();});this.$RTISubscriptionManager5=false;this.flush();};q.prototype.flush=function(){if(this.isReady()&&!this.$RTISubscriptionManager5){this.$RTISubscriptionManager5=true;this.$RTISubscriptionManager6=false;var t=[],u={};if(!this.$RTISubscriptionManager7)u.reset=true;this.forEachSubscription(function(w,x){if(x.isDirty()){var y='subscriptions',z=u[y];if(!z){z=[];u[y]=z;}t.push(x);x.setDirty(false);x.setSent(false);var aa={topic:x.getTopic(),state:x.getState(),context:x.getContext()};z.push(aa);}});var v=(function(w){var x=w.data!=null;if(!this.$RTISubscriptionManager7&&x)this.$RTISubscriptionManager7=true;for(var y=0;y<t.length;y++){var z=t[y];z.setSent(x);z.setDirty(!x);var aa=z.getSubscribeCallback();if(aa!==null)m.applyWithGuard(aa,this,[w]);}this.deleteSubscriptions(function(ba){return ba.getState()===o.UNSUBSCRIBE&&ba.isSent();});this.$RTISubscriptionManager5=false;if(this.$RTISubscriptionManager6){this.$RTISubscriptionManager6=false;this.flush();}}).bind(this);if(Object.keys(u).length>0){this.$RTISubscriptionManager8.issueRequest('/sub',{},u,v);}else this.$RTISubscriptionManager5=false;}else{this.$RTISubscriptionManager6=true;if(!this.$RTISubscriptionManager5)this.getCurrentSession();}};q.prototype.deleteSubscriptions=function(t){!t?j(0):undefined;var u=[];this.forEachSubscription(function(w,x){if(t.apply(this,[x]))u.push(w);});for(var v=0;v<u.length;v++)delete this.$RTISubscriptionManager1[u[v]];};q.prototype.forEachSubscription=function(t){!t?j(0):undefined;for(var u in this.$RTISubscriptionManager1)if(this.$RTISubscriptionManager1.hasOwnProperty(u))t.apply(this,[u,this.$RTISubscriptionManager1[u]]);};q.prototype.isSubscribed=function(t){!t?j(0):undefined;return t in this.$RTISubscriptionManager1;};q.prototype.isReady=function(){if(this.$RTISubscriptionManager8&&this.$RTISubscriptionManager2!==null&&this.$RTISubscriptionManager2)return true;return false;};q.prototype.getCurrentSession=function(){l.inform(h.GET_RTI_SESSION_REQUEST);};function r(t){this.$SubscriptionToken1=t;}r.prototype.unsubscribe=function(){q.unsubscribe(this.$SubscriptionToken1.getTopic());};function s(t,u,v,w){this.$SubscriptionData1=t;this.$SubscriptionData2=u;this.$SubscriptionData3=true;this.$SubscriptionData4=false;this.$SubscriptionData5=o.SUBSCRIBE;this.$SubscriptionData6=null;if(v){this.$SubscriptionData7=v;}else this.$SubscriptionData7={};if(w){this.$SubscriptionData8=w;}else this.$SubscriptionData8=null;}s.prototype.getTopic=function(){return this.$SubscriptionData1;};s.prototype.getListener=function(){return this.$SubscriptionData2;};s.prototype.getSubscribeCallback=function(){return this.$SubscriptionData8;};s.prototype.getArbiterToken=function(){return this.$SubscriptionData6;};s.prototype.setArbiterToken=function(t){this.$SubscriptionData6=t;};s.prototype.isDirty=function(){return this.$SubscriptionData3;};s.prototype.setDirty=function(t){this.$SubscriptionData3=t;};s.prototype.getState=function(){return this.$SubscriptionData5;};s.prototype.setState=function(t){this.$SubscriptionData5=t;};s.prototype.getContext=function(){return this.$SubscriptionData7;};s.prototype.isSent=function(){return this.$SubscriptionData4;};s.prototype.setSent=function(t){this.$SubscriptionData4=t;};s.prototype.prepareUnsubscribe=function(){this.setState(o.UNSUBSCRIBE);this.setDirty(true);this.setSent(false);};n.onUnload(function(){q.unsubscribeAll();});q.PULL_HINT_DELAY_MILLIS=10000;Object.keys(q.prototype).forEach(function(t){q[t]=function(){var u=q;return q.prototype[t].apply(u,arguments);};});q.call(q);f.exports=q;},null);
__d('SearchPushUpdatingModule',['Arbiter','AsyncRequest','CSS','DOM','EventListener','NavigationMessage','RTISubscriptionManager','Run','SubscriptionsHandler','URI','cx'],function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){if(c.__markCompiled)c.__markCompiled();'use strict';function s(t){this.options=t;this.insertedResults=[];this.subscriptionsHandler=new p();k.appendContent(this.options.root,this.options.pill);this.enable();}s.prototype.enable=function(){o.onLeave((function(){this.disable();}).bind(this));n.subscribe(this.options.push_channel,this.onSubscriptionUpdate.bind(this));this.subscriptionsHandler.addSubscriptions(h.subscribe(m.NAVIGATION_BEGIN,(function(){this.disable();}).bind(this)),h.subscribe('BlueBar/homeClick',(function(){this.disable();}).bind(this)),l.listen(this.options.pill,'click',this.onPillClick.bind(this)));};s.prototype.disable=function(){j.removeClass(this.options.root,"_5jb6");n.unsubscribe(this.options.push_channel);this.pullRequest&&this.pullRequest.abort();this.subscriptionsHandler.release();};s.prototype.onSubscriptionUpdate=function(t){var u=t.payload.story_id;if(this.options.story_ids.indexOf(u)>-1)return;this.options.story_ids.push(u);var v=new q(this.options.pull_uri).addQueryData({story_id:u});this.pullRequest=new i().setMethod('post').setURI(v).setHandler(this.onRequestResponse.bind(this));this.pullRequest.send();};s.prototype.onRequestResponse=function(t){var u=t.payload.result;if(u){var v=k.prependContent(this.options.root,u);u=v[0];this.insertedResults.push(u);j.addClass(u,"_5jb7");j.addClass(this.options.root,"_5jb6");}};s.prototype.onPillClick=function(){j.removeClass(this.options.root,"_5jb6");while(this.insertedResults.length>0)j.removeClass(this.insertedResults.pop(),"_5jb7");};f.exports=s;},null);